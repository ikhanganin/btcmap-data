# This script updates BTC Map areas of a given type with the KM^2 area of
# its GeoJSON.

import requests
import json
import sys
import os

# Get the bearer token from the environment variable
btcmap_api_token = os.getenv("BTCMAP_API_TOKEN")

if not btcmap_api_token:
    print("Please set the BTCMAP_API_TOKEN environment variable.")
    sys.exit(1)

id = 'tw'

# Define the API URL to fetch all areas
url = f"https://api.btcmap.org/areas/{id}"
headers = {
    'Authorization': f'Bearer {btcmap_api_token}',
    'Content-Type': 'application/json'
}

# Tags for area
tags = """
{
  "tags":
  {
    "type": "country",
    "iso_a2": "TW",
    "iso_a3": "TWN",
    "wikidataid": "Q865",
    "name": "Taiwan",
    "country_type": "Sovereign country",
    "sovereignt": "Taiwan",
    "continent": "Asia",
    "region_un": "Asia",
    "subregion": "Eastern Asia",
    "region_wb": "East Asia & Pacific",
    "lat": 23.652408,
    "lon": 120.868204,
    "area_km2": 36073,
    "population": 23568378,
    "population:rank": 15,
    "population:year": 2020,
    "gdp_md": 1127000,
    "gdp_year": 2016,
    "economy": "2. Developed region: nonG7",
    "income_grp": "2. High income: nonOECD",
    "geo_json": {
      "type": "MultiPolygon",
      "coordinates": [
        [
          [
            [
              121.0087890625,
              22.620361328125
            ],
            [
              121.16123046875003,
              22.7763671875
            ],
            [
              121.2958984375,
              22.966601562500003
            ],
            [
              121.35224609375001,
              23.067285156249994
            ],
            [
              121.3974609375,
              23.172509765624994
            ],
            [
              121.47714843750003,
              23.424072265625
            ],
            [
              121.52607421875001,
              23.668261718750003
            ],
            [
              121.58339843750002,
              23.860888671875003
            ],
            [
              121.61308593749999,
              24.052734375
            ],
            [
              121.63935546875001,
              24.130078125
            ],
            [
              121.73701171875001,
              24.28525390624999
            ],
            [
              121.82802734375002,
              24.534375
            ],
            [
              121.82636718750001,
              24.640527343749994
            ],
            [
              121.81337890625002,
              24.746337890625
            ],
            [
              121.82011718749999,
              24.824511718750003
            ],
            [
              121.85625,
              24.895263671875
            ],
            [
              121.92900390624999,
              24.97373046874999
            ],
            [
              121.90517578125002,
              25.056445312500003
            ],
            [
              121.85283203124999,
              25.104443359374997
            ],
            [
              121.73330078125002,
              25.154101562500003
            ],
            [
              121.68710937500003,
              25.181591796874997
            ],
            [
              121.64306640625,
              25.232421875
            ],
            [
              121.59365234375002,
              25.275341796874997
            ],
            [
              121.51708984375,
              25.276904296875003
            ],
            [
              121.44960937500002,
              25.2490234375
            ],
            [
              121.36542968750001,
              25.1591796875
            ],
            [
              121.09541015625001,
              25.065087890624994
            ],
            [
              121.040625,
              25.0328125
            ],
            [
              120.96406250000001,
              24.927978515625
            ],
            [
              120.90156250000001,
              24.81328125
            ],
            [
              120.8359375,
              24.72265625
            ],
            [
              120.75742187500003,
              24.642285156249997
            ],
            [
              120.62968749999999,
              24.478515625
            ],
            [
              120.15898437499999,
              23.709033203125003
            ],
            [
              120.13212890624999,
              23.65292968749999
            ],
            [
              120.12539062500002,
              23.526611328125
            ],
            [
              120.14296875000002,
              23.399072265624994
            ],
            [
              120.12119140625003,
              23.30517578125
            ],
            [
              120.08554687500003,
              23.212060546874994
            ],
            [
              120.07246093750001,
              23.14975585937499
            ],
            [
              120.08339843750002,
              23.093701171874997
            ],
            [
              120.12158203125,
              23.037011718749994
            ],
            [
              120.15009765625001,
              22.974902343750003
            ],
            [
              120.23281250000002,
              22.717919921874994
            ],
            [
              120.27285156250002,
              22.62744140625
            ],
            [
              120.32558593750002,
              22.542431640624997
            ],
            [
              120.31621093749999,
              22.547607421875
            ],
            [
              120.38759765625002,
              22.484521484374994
            ],
            [
              120.47978515624999,
              22.44189453125
            ],
            [
              120.58125,
              22.356396484374997
            ],
            [
              120.60761718750001,
              22.312548828125003
            ],
            [
              120.67802734374999,
              22.15966796875
            ],
            [
              120.69013671875001,
              22.033105468749994
            ],
            [
              120.74277343750003,
              21.956005859374997
            ],
            [
              120.83984375,
              21.925
            ],
            [
              120.8642578125,
              22.032666015624997
            ],
            [
              120.87841796875,
              22.141552734374997
            ],
            [
              120.87734375000002,
              22.26220703125
            ],
            [
              120.89736328125002,
              22.379150390625
            ],
            [
              120.946875,
              22.503076171874994
            ],
            [
              121.0087890625,
              22.620361328125
            ]
          ]
        ],
        [
          [
            [
              118.40742187500001,
              24.522119140624994
            ],
            [
              118.33935546875,
              24.469140625
            ],
            [
              118.28730468750001,
              24.476611328125003
            ],
            [
              118.29511718750001,
              24.436328125
            ],
            [
              118.43271484375003,
              24.414355468750003
            ],
            [
              118.451171875,
              24.45556640625
            ],
            [
              118.40742187500001,
              24.522119140624994
            ]
          ]
        ]
      ]
    }
  }
}"""

payload = json.loads(tags)
print(payload)

# Send a PATCH request to update the 'km2' tag
response = requests.patch(url, headers=headers, data=payload)

if response.status_code == 200:
    print(f"Successfully patched {id}")
else:
    print(f"Error updating {id}: {response.text}")
